name: MSBuild C++ CI - Build and Test

on:
  push:
    branches: [ main, master, develop, 'feature/*', 'fix/*' ]
  pull_request:
    branches: [ main, master, develop ]

env:
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64
  SOLUTION_FILE: LeapYear.sln  # Укажите имя вашего .sln файла

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    # Шаг 1: Загрузка кода репозитория
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Шаг 2: Восстановление NuGet пакетов (если используете)
    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}
      
    # Шаг 3: Поиск пути к MSBuild (Visual Studio 2022)
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17.0'  # Visual Studio 2022

    # Шаг 4: Сборка основного проекта
    - name: Build Solution
      run: |
        msbuild ${{ env.SOLUTION_FILE }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=${{ env.BUILD_PLATFORM }} `
          /m `
          /verbosity:minimal

    # Шаг 5: Запуск Google Tests
    - name: Run Google Tests
      run: |
        # Находим исполняемый файл тестов (адаптируйте путь под вашу структуру)
        $TestExecutable = Get-ChildItem -Path "." -Recurse -Filter "*Tests*.exe" | 
                          Where-Object { $_.FullName -like "*${{ env.BUILD_CONFIGURATION }}*" -and $_.FullName -like "*${{ env.BUILD_PLATFORM }}*" } |
                          Select-Object -First 1
        
        if ($TestExecutable) {
            Write-Host "Running tests from: $($TestExecutable.FullName)"
            & $TestExecutable.FullName --gtest_output=xml:test_results.xml
        } else {
            Write-Error "Test executable not found!"
            # Попробуем альтернативный путь
            $AlternativePath = ".\*Tests\bin\${{ env.BUILD_PLATFORM }}\${{ env.BUILD_CONFIGURATION }}\*Tests.exe"
            $AltTestExecutable = Get-ChildItem -Path $AlternativePath -ErrorAction SilentlyContinue
            if ($AltTestExecutable) {
                Write-Host "Found test executable at: $($AltTestExecutable.FullName)"
                & $AltTestExecutable.FullName --gtest_output=xml:test_results.xml
            } else {
                exit 1
            }
        }

    # Шаг 6: Публикация результатов тестов (ИСПРАВЛЕННАЯ ВЕРСИЯ)
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_id }}
        path: |
          test_results.xml
          **/*.trx
        retention-days: 7

    # Дополнительно: Публикация артефактов сборки
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.run_id }}
        path: |
          **/bin/${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/*.exe
          **/bin/${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/*.dll
          **/bin/${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/*.pdb
        retention-days: 7